# Курсовая работа: Установка и настройка k8s и GitLab CI/CD для сборки собственного приложения и деплоя инфраструктуры

## Поставленные задачи

1. Автоматическое развёртывание K8S посредством Kubespray
2. В K8S будет посредством Helm развёрнут Gitlab
3. В Gitlab будет поднят пайплайн для сбоки и деплоя в K8S собственного Java приложения
4. Дополнительно в качестве обвязки к приложению будут подняты следущие сервисы: PostgreSQL, OpenVPN, Shadowsocks, Stubby, Prometheus, Grafana

## Итоговая цель

Должен быть создан Telegram бот, который принимает на вход доменные имена/ip адреса/автономные системы. Все ip адреса собираются через DoT эндпоинты google/cloudflare. Кроме того бот сможет отдавать сгенерированный ovpn конфиг для клиента.

Далее, Java приложение соберёт все необходимые ip адреса, и создаст на внешнем роутере маршруты, в которые будет идти трафик, если он удовлетворяет конечному назначению из переданного списка. Сам трафик будет идти по пути Client -> Router -> Local Server -> OpenVPN -> ShadowSocks -> RemoteServer -> Internet

Также будет создан альтернативный endpoint, который позволит всем подключенным клиентам уводить весь трафик в vpn.

Альтернативно, все подключенные извне клиенты смогут получить конфиги для полного увода трафика в vpn, либо трафика для списка узлов, в таком случае роутер используется только как точка входа в систему.

В метриках предполагается отслеживание системных ресурсов, количества подключенных клиентов, объёма проходящего трафика. Алерты на утилизацию ресурсов, количество подключенных клиентов, объём трафика в секунду.

Все исходники будут выложены на Github.


## По пунктам

1. Однонодовый кластер k8s разворачивается посредством локального запуска kubespray, инвентори лежит тут:
    - `src/cluster/kubespray/inventory/mycluster`


2. Данный пункт был изменён, так как у моего железа не хватило мощностей для стабильной работы Gitlab из стандартного Helm чарта. Созданы следующие конфиги:
    - `src/cluster/cert-manager` -- скрипт для развёртывания cert-manager посредством Helm, и манифест для выпуска сертов.
    - `src/cluster/ingress-nginx` -- скрипт для развёртывания ingress-nginx посредством Helm, и values для настройки.
    - `src/cluster/gitlab-omnibus` -- манифесты для развёртывания реализации omnibus, runner и ingress стрима с tls сертификатом LetsEncrypt. Также имеются скрипты автоматического развёртывания и удаления Gitlab.


3. Для данного пункта был написан пайплайн, который удовлетворяет таким требованиям:
    - Автоматическая сборка/деплой элементов системы при изменении кодовой базы/манифестов
    - Автоматическая расшифровка секретных файлов, и установка их в нужный namespace
    - Возможность принудительного выполнения стадий по настройкам конфига
    - Автоматический пуш новых версий контейнеров в docker hub



4. В обвязке элемент OpenVPN был заменён на socat
    - Все остальные элементы обвязки выложены:
        - `src/k8s/environment/builders` - сборщики контейнеров
        - `src/k8s/environment/manifests` - манифесты для деплоя
        - `src/k8s/environment/secrets_remote` - зашифрованные файлы с чувствительной информацией, расшифровываются в пайплайне
        - `src/ci/hooks/pre-commit` - хук для git, который обеспечивает шифровку файлов конфигов, и работу принудительных стадий пайплайна


### Касательно итоговой цели

Так как вместо двойного туннеля используется форвардинг через socat сквозь shadowSocks, то необходимость в отдельном эндпоинте OpenVPN внутри кластера отпала, все клиенты желающие использовать частичную маршрутизации через vpn могут подключаться непосредственно к роутеру, на котором будет свой OpenVPN сервер.

Из бота на текущий момент собираются метрики:
- Количество подключенных клиентов
- Количество выданых конфигов с момента последенего включения

Также собираются общие метрики системы, настроены алерты по утилизации ресурсов.
